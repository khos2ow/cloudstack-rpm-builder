# defaults: &defaults
#   machine:
#     services:
#       - docker
#   steps:
#   - checkout
#   - run:
#       name: "Setup required directories"
#       command: |
#         mkdir -p /tmp/apache-cloudstack
#         mkdir -p /tmp/.m2
#   - restore_cache:
#       key: repo-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-m2
#   - run:
#       name: "Build Docker image"
#       command: make ${TAG}
#   - run:
#       name: "Test Docker image"
#       command: |
#         docker run \
#           --volume /tmp/apache-cloudstack:/mnt/build \
#           --volume /tmp/.m2:/root/.m2 \
#           --rm \
#           ${IMAGE}:${TAG} \
#             --git-remote ${BUILD_REPO} \
#             --git-ref ${BUILD_REF} \
#             --remove-first \
#             ${BUILD_PARAMS}
#   - save_cache:
#       key: repo-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-m2
#       paths:
#         - /tmp/.m2

version: 2.1

jobs:
  test:
    parameters:
      tag:
        type: string
      ref:
        type: string
      param:
        type: string
    docker:
      - image: circleci/buildpack-deps:stretch
    steps:
    - checkout
    - run:
        name: "Test Docker image"
        command: |
          docker run \
            --volume /tmp/apache-cloudstack:/mnt/build \
            --volume /tmp/.m2:/root/.m2 \
            --rm \
            khos2ow/cloudstack-rpm-builder:<<parameters.tag>> \
              --git-remote https://github.com/apache/cloudstack.git \
              --git-ref <<parameters.ref>> \
              --remove-first \
              <<parameters.param>>

  centos6:
    # <<: *defaults
    docker:
      - image: circleci/buildpack-deps:stretch
    steps:
    - checkout
    - run:
        name: "Build Docker image"
        command: make ${TAG}
    environment:
      TAG: centos6

  # centos7:
  #   <<: *defaults
  #   environment:
  #     IMAGE: khos2ow/cloudstack-rpm-builder
  #     TAG: centos7
  #     BUILD_REPO: https://github.com/apache/cloudstack.git
  #     BUILD_REF: refs/heads/4.13
  #     BUILD_PARAMS: --distribution centos7

  # latest:
  #   <<: *defaults
  #   environment:
  #     IMAGE: khos2ow/cloudstack-rpm-builder
  #     TAG: centos7
  #     BUILD_REPO: https://github.com/apache/cloudstack.git
  #     BUILD_REF: refs/heads/4.13
  #     BUILD_PARAMS: --distribution centos7

workflows:
  version: 2
  build:
    jobs:
    - test:
        name: test-centos6
        tag: centos6
        ref: refs/heads/4.13
        param: --distribution centos63
        requires:
        - centos6

    - centos6:
        filters:
          branches:
            ignore: master

    # - centos7:
    #     filters:
    #       branches:
    #         ignore: master

  # release:
  #   jobs:
  #   - centos6:
  #       filters:
  #         branches:
  #           only: master
  #           ignore: /.*/

  #   - centos7:
  #       filters:
  #         branches:
  #           only: master
  #           ignore: /.*/

  #   - latest:
  #       filters:
  #         branches:
  #           only: master
  #           ignore: /.*/

